# OpenAPI Development Skill

## Description

Guide for contributing to the OpenAPI layer at `src/Shared/Application/OpenApi/`. This skill covers architecture patterns, best practices, and complexity management techniques adopted from the user-service repository.

## When to Use This Skill

Use this skill when:

- Adding new OpenAPI endpoint factories
- Creating new processors for spec transformation
- Adding parameter descriptions or validation
- Modifying OpenAPI generation logic
- Fixing OpenAPI validation errors
- Reducing cyclomatic complexity in OpenAPI code

## Architecture Overview

The OpenAPI layer follows a **Processor Pattern** with clear separation of concerns:

```
src/Shared/Application/OpenApi/
â”œâ”€â”€ Builder/              # Schema and parameter builders
â”œâ”€â”€ Factory/              # Endpoint, request, response, and URI parameter factories
â”œâ”€â”€ Processor/            # Spec transformation processors
â””â”€â”€ OpenApiFactory.php    # Main coordinator
```

### Key Principles

1. **Single Responsibility**: Each processor/factory handles ONE specific concern
2. **Immutability**: Use `with*()` methods to create new instances instead of mutating
3. **Functional Programming**: Prefer `array_map`, `array_filter`, `array_combine` over loops
4. **Match Expressions**: Use PHP 8 `match` instead of if-else chains for lower complexity
5. **Early Returns**: Use guard clauses and early returns to reduce nesting

**ðŸ“– For detailed patterns and techniques**, see [Processor Patterns Reference](reference/processor-patterns.md)

## Directory Structure

### Builder/

Contains classes that build OpenAPI schema components:

- **`ContextBuilder`**: Builds request body contexts (application/problem+json)
- **`ArrayContextBuilder`**: Builds array contexts (application/ld+json)
- **`Parameter`**: Value object for parameter data with `Requirement` enum
- **`ParameterSchemaFactory`**: Creates parameter schemas from `Parameter` objects
- **`ResponseBuilder`**: Builds OpenAPI response objects
- **`UriParameterBuilder`**: Builds path parameter objects
- **`Requirement`**: Enum for REQUIRED/OPTIONAL parameter states

### Factory/

Contains factories that create OpenAPI components:

#### Factory/Endpoint/

Endpoint factories create custom API endpoints not generated by API Platform:

- **`EndpointFactoryInterface`**: Interface all endpoint factories must implement
- **`HealthCheckEndpointFactory`**: Creates health check endpoint

**Pattern**: Each endpoint factory modifies the OpenApi object in-place via `createEndpoint(OpenApi $openApi): void`

#### Factory/Request/

Request factories build request body schemas:

- **`CreateCustomerRequestFactory`**: Schema for customer creation
- **`UpdateCustomerRequestFactory`**: Schema for customer updates

#### Factory/Response/

Response factories build response schemas:

- **`ResponseFactoryInterface`**: Interface for response factories
- **`HealthCheckResponseFactory`**: Health check response schema
- **`ServerErrorResponseFactory`**: 500 error response schema
- **`ValidationErrorFactory`**: 422 validation error response schema

#### Factory/UriParameter/

URI parameter factories build path parameters:

- **`UlidUriParameterFactory`**: Base factory for ULID parameters
- **`UlidUriCustomerFactory`**: Customer ULID parameter
- **`UlidUriCustomerStatus`**: Customer status ULID parameter
- **`UlidUriCustomerType`**: Customer type ULID parameter

### Processor/

Processors transform the generated OpenAPI spec:

- **`ParameterDescriptionAugmenter`**: Adds descriptions to query/filter parameters
- **`PathParametersSanitizer`**: Cleans path parameters
- **`PathParameterCleaner`**: Removes deprecated properties from path parameters
- **`IriReferenceTypeFixer`**: Fixes IRI reference types (iri-reference â†’ string with format)
- **`TagDescriptionAugmenter`**: Adds descriptions to OpenAPI tags

### OpenApiFactory.php

Main coordinator that orchestrates all factories and processors:

```php
public function __invoke(array $context = []): OpenApi
{
    $openApi = $this->decorated->__invoke($context);

    foreach ($this->endpointFactories as $endpointFactory) {
        $endpointFactory->createEndpoint($openApi);
    }

    $this->parameterDescriptionAugmenter->augment($openApi);
    $openApi = $this->tagDescriptionAugmenter->augment($openApi);
    $this->iriReferenceTypeFixer->fix($openApi);
    $openApi = $this->pathParametersSanitizer->sanitize($openApi);

    return $openApi;
}
```

## How to Add New Components

### Adding a New Processor

1. **Create the processor class**:

```php
// src/Shared/Application/OpenApi/Processor/YourProcessor.php
namespace App\Shared\Application\OpenApi\Processor;

use ApiPlatform\OpenApi\OpenApi;

final class YourProcessor
{
    private const OPERATIONS = ['Get', 'Post', 'Put', 'Patch', 'Delete'];

    public function process(OpenApi $openApi): OpenApi
    {
        foreach (array_keys($openApi->getPaths()->getPaths()) as $path) {
            $pathItem = $openApi->getPaths()->getPath($path);
            $openApi->getPaths()->addPath(
                $path,
                $this->processPathItem($pathItem)
            );
        }
        return $openApi;
    }

    private function processPathItem(PathItem $pathItem): PathItem
    {
        foreach (self::OPERATIONS as $operation) {
            $pathItem = $pathItem->{'with' . $operation}(
                $this->processOperation($pathItem->{'get' . $operation}())
            );
        }
        return $pathItem;
    }

    private function processOperation(?Operation $operation): ?Operation
    {
        return match (true) {
            $operation === null => null,
            // Add your conditions...
            default => $operation,
        };
    }
}
```

2. **Inject it into OpenApiFactory**:

```php
// src/Shared/Application/OpenApi/OpenApiFactory.php
public function __construct(
    private OpenApiFactoryInterface $decorated,
    private iterable $endpointFactories,
    private PathParametersSanitizer $pathParametersSanitizer
        = new PathParametersSanitizer(),
    private YourProcessor $yourProcessor = new YourProcessor(),  // Add here
    // ...
) {}

public function __invoke(array $context = []): OpenApi
{
    $openApi = $this->decorated->__invoke($context);

    // ...
    $openApi = $this->yourProcessor->process($openApi);  // Add here

    return $openApi;
}
```

### Adding a New Endpoint Factory

1. **Create the factory**:

```php
// src/Shared/Application/OpenApi/Factory/Endpoint/YourEndpointFactory.php
namespace App\Shared\Application\OpenApi\Factory\Endpoint;

use ApiPlatform\OpenApi\OpenApi;
use ApiPlatform\OpenApi\Model;

final readonly class YourEndpointFactory implements EndpointFactoryInterface
{
    public function createEndpoint(OpenApi $openApi): void
    {
        $pathItem = new Model\PathItem(
            post: new Model\Operation(
                operationId: 'yourOperation',
                tags: ['YourTag'],
                summary: 'Your endpoint summary',
                description: 'Your endpoint description',
                responses: [
                    '200' => new Model\Response(
                        description: 'Success',
                        content: new \ArrayObject([
                            'application/json' => [
                                'schema' => [
                                    'type' => 'object',
                                    'properties' => [
                                        'status' => ['type' => 'string'],
                                    ],
                                ],
                            ],
                        ])
                    ),
                ],
            )
        );

        $openApi->getPaths()->addPath('/your-endpoint', $pathItem);
    }
}
```

2. **Register in services.yaml**:

```yaml
# config/services.yaml
App\Shared\Application\OpenApi\Factory\Endpoint\YourEndpointFactory:
  tags: ['app.openapi_endpoint_factory']
```

The factory will be auto-discovered and injected into `OpenApiFactory`.

### Adding Parameter Descriptions

1. **Add to ParameterDescriptionAugmenter**:

```php
// src/Shared/Application/OpenApi/Processor/ParameterDescriptionAugmenter.php

private function getYourFilterDescriptions(): array
{
    return [
        'yourParam' => 'Description of your parameter',
        'yourParam[]' => 'Description for array variant',
        'yourParam[nested]' => 'Description for nested parameter',
    ];
}

private function getParameterDescriptions(): array
{
    return array_merge(
        $this->getOrderDescriptions(),
        $this->getFilterDescriptions(),
        $this->getYourFilterDescriptions(),  // Add here
        // ...
    );
}
```

2. **Keep methods under 20 lines**: If a method grows too large, split it into multiple provider methods.

### Adding a New Builder

1. **Create the builder class**:

```php
// src/Shared/Application/OpenApi/Builder/YourBuilder.php
namespace App\Shared\Application\OpenApi\Builder;

final class YourBuilder
{
    public function build(/* parameters */): mixed
    {
        return /* your built object */;
    }
}
```

2. **Use it in factories or processors**:

```php
$yourBuilder = new YourBuilder();
$result = $yourBuilder->build(...);
```

## Complexity Management

### Target Metrics

From PHPInsights configuration:

- **Min Complexity**: 93% (source code threshold)
- **Max Cyclomatic Complexity per Method**: 10 (PHPMD threshold)
- **Max Method Length**: 20 lines
- **Max Cyclomatic Complexity per Class**: Aim for â‰¤ 8

### Quick Tips

1. **Use Match Instead of If-Else** - Each `match` case = 1 complexity vs each `if`/`elseif` = +1
2. **Extract Conditions to Variables** - Reduce boolean complexity
3. **Use Early Returns** - Avoid nested conditionals
4. **Replace Loops with array_map/array_filter** - More declarative, lower complexity
5. **Split Long Methods** - Extract helper methods when over 20 lines

### Common Pitfalls

1. **Don't Mutate OpenApi Objects Directly** - Use `with*()` methods instead
2. **Don't Use empty()** - Forbidden by PHPInsights, use explicit checks (`$array === []`)
3. **Don't Create God Classes** - Split into multiple processors
4. **Don't Forget OPERATIONS Constant** - Loop instead of chaining

**ðŸ“– For detailed complexity patterns**, see [Processor Patterns Reference](reference/processor-patterns.md)
**ðŸ“– For general complexity management**, see [complexity-management skill](../complexity-management/SKILL.md)

## Testing Your Changes

### 1. Generate and Validate OpenAPI Spec

```bash
make generate-openapi-spec
make validate-openapi-spec
```

Expected output: `No results with a severity of 'hint' or higher found!`

### 2. Run PHPInsights

```bash
make phpinsights
```

Expected scores:

- Code: 99-100%
- Complexity: â‰¥93% (source code)
- Architecture: 100%
- Style: 100%

### 3. Run Unit Tests

```bash
make unit-tests
```

Expected: All tests pass with 100% coverage

### 4. Check Complexity

```bash
make phpmd
```

Expected: No violations

## Additional Resources

**ðŸ“– [Processor Patterns Reference](reference/processor-patterns.md)** - Detailed patterns and techniques for reducing complexity

**ðŸ“– [Complete Examples](examples/complete-examples.md)** - Real-world examples from the codebase with troubleshooting and configuration

**ðŸ”§ Related Skills**:

- [complexity-management](../complexity-management/SKILL.md) - General complexity reduction strategies
- [deptrac-fixer](../deptrac-fixer/SKILL.md) - Fixing architecture violations

---

- `augmentOperation()`: Uses match expression
- `augmentParameters()`: Uses array_map
- `augmentParameter()`: Static pure function

### Example 2: IriReferenceTypeFixer

Shows complexity reduction:

- Match for null/empty checks
- Extracted `fixProperties()` and `fixProperty()` methods
- array_map for transformation

**Location**: `src/Shared/Application/OpenApi/Processor/IriReferenceTypeFixer.php`

**Complexity Journey**:

- Original: 12 cyclomatic complexity
- After refactoring: 8 cyclomatic complexity

### Example 3: PathParametersSanitizer

Shows delegation pattern:

- Delegates to `PathParameterCleaner`
- Uses OPERATIONS constant
- Match expression for operation processing

**Location**: `src/Shared/Application/OpenApi/Processor/PathParametersSanitizer.php`

## Configuration Files

### phpinsights.php

Key configuration:

```php
'requirements' => [
    'min-quality' => 100,
    'min-complexity' => 93,  // Project standard (NEVER decrease below 93%)
    'min-architecture' => 100,
    'min-style' => 100,
],
'remove' => [
    // DisallowMixedTypeHintSniff disabled for API Platform's dynamic structures
    SlevomatCodingStandard\Sniffs\TypeHints\DisallowMixedTypeHintSniff::class,
],
```

### phpmd.xml

```xml
<rule name="CyclomaticComplexity">
    <properties>
        <property name="reportLevel" value="10"/>
    </properties>
</rule>
```

## Resources

- **User-Service Reference**: https://github.com/VilnaCRM-Org/user-service/tree/copilot/fix-45
- **API Platform Docs**: https://api-platform.com/docs/
- **OpenAPI 3.1 Spec**: https://spec.openapis.org/oas/v3.1.0
- **Spectral Validation**: https://stoplight.io/open-source/spectral

## Troubleshooting

### "Cyclomatic complexity too high"

- Use match expressions instead of if-else
- Extract methods (keep each under 20 lines)
- Replace loops with array functions
- Extract conditions to variables

### "Function too long"

- Split into helper methods
- Each method should do ONE thing
- Aim for â‰¤15 lines per method

### "Spectral validation errors"

- Check `.spectral.yaml` for rules
- Ensure all operations have descriptions
- Verify parameter schemas are correct
- Run cleanup script: `python3 scripts/cleanup-openapi-parameters.py`

### "Mixed type hint not allowed"

- Already disabled in phpinsights.php
- If you see this error, verify phpinsights.php configuration

### "Architecture score too low"

- Check Deptrac violations
- Ensure dependencies flow correctly: Infrastructure â†’ Application â†’ Domain
- Don't import Domain into Infrastructure

## Summary Checklist

When contributing to OpenAPI layer:

- [ ] Use OPERATIONS constant for HTTP methods
- [ ] Use match expressions instead of if-else
- [ ] Keep methods under 20 lines
- [ ] Keep cyclomatic complexity under 10
- [ ] Use functional array operations
- [ ] Make pure functions static
- [ ] Avoid empty() - use explicit checks
- [ ] Use early returns and guard clauses
- [ ] Delegate to specialized classes
- [ ] Test with `make validate-openapi-spec`
- [ ] Verify with `make phpinsights`
- [ ] Run `make unit-tests`

**Summary**: This skill provides the core workflow for contributing to the OpenAPI layer. For detailed patterns, examples, and troubleshooting, see the reference files above.
